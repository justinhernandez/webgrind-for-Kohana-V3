<?php

// initialize static functions
Webgrind_Config::init();

/**
 * Configuration for webgrind
 * @author Jacob Oettinger
 * @author Joakim NygÃ¥rd
 */
class Webgrind_Config extends Webgrind_MasterConfig {

	// define static variaables available in config
	public static $checkVersion;
	public static $hideWebgrindProfiles;
	public static $storageDir;
	public static $profilerDir;
	public static $preprocessedSuffix;
	public static $defaultTimezone;
	public static $dateFormat;
	public static $defaultCostformat;
	public static $defaultFunctionPercentage;
	public static $defaultHideInternalFunctions;
	public static $pythonExecutable;
	public static $dotExecutable;
	public static $fileUrlFormat;
	public static $traceFileListFormat;
	public static $styleDir;
	public static $jsDir;
	public static $imgDir;
	public static $baseUrl;
	public static $gprof2dotPath;
	
	
	/**
	 * Initialize static class variables from webgrind config 
	 */
	static function init()
	{
		$vals = Kohana::$config->load('webgrind');
		// iterate values
		foreach ($vals as $name => $val)
			self::$$name = $val;
	}

    #########################
    # BELOW NOT FOR EDITING #
    #########################

	/**
	* Regex that matches the trace files generated by xdebug
	*/
    static function xdebugOutputFormat() {
        $outputName = ini_get('xdebug.profiler_output_name');
		if($outputName=='') // Ini value not defined
			$outputName = '/^cachegrind\.out\..+$/';
		else
	    	$outputName = '/^'.preg_replace('/(%[^%])+/', '.+', $outputName).'$/';
	    return $outputName;
    }
	
	/**
	* Directory to search for trace files
	*/
	static function xdebugOutputDir() {
		$dir = ini_get('xdebug.profiler_output_dir');
		if($dir=='') // Ini value not defined
			return realpath(Webgrind_Config::$profilerDir).'/';
	    return realpath($dir).'/';
	}
	
	/**
	* Writable dir for information storage
	*/
	static function storageDir() {
	    if (!empty(Webgrind_Config::$storageDir))
	        return realpath(Webgrind_Config::$storageDir).'/';
	        
	    if (!function_exists('sys_get_temp_dir') || !is_writable(sys_get_temp_dir())) {
	        # use xdebug setting
            return Webgrind_Config::xdebugOutputDir();
	    }
	    return realpath(sys_get_temp_dir()).'/';
	}
}
